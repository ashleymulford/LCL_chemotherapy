LCL_chemotherapy Progress:

#1 Explored data available in /home/wheelerlab3/Data/LCL_chemotherapy/

    Drug            populations         uM_concentrations               best_phenotype  hrs_drug_treatment      serum_used      phenotype               commercial_assay   exception_populations   exception_uM_concentrations
1.  cisplatin       CEU,YRI,ASN         0,1,2.5,5,10,20                 IC50            48                      FBS             cell_growth_inhibition  alamarBlue         ASN                     0,0.1,0.5,1,5,10,20,40
2.  carboplatin     CEU,YRI,ASN         0,10,20,40,80                   IC50            72                      FBS             cell_growth_inhibition  alamarBlue
3.  capecitabine    CEU,YRI,ASN         0,2.5,10,20,40                  AUC             72                      FBS             cell_growth_inhibition  alamarBlue
4.  daunorubicin    CEU,YRI             0,0.0125,0.025,0.05,0.1,0.2,1   IC50            72                      FBS             cell_growth_inhibition  alamarBlue
5.  pemetrexed      CEU,YRI             0,0.02,0.1,0.5                  AUC             72                      FBS             cell_growth_inhibition  alamarBlue
6.  arac            CEU,YRI,ASN         0,1,5,10,40                     AUC             72                      FBS             cell_growth_inhibition  alamarBlue
7.  etoposide       CEU,YRI             0,0.02,0.1,0.5,2.5              IC50            72                      FBS             cell_growth_inhibition  alamarBlue
8.  paclitaxel      CEU,YRI             0,0.00625,0.0125,0.05           AUC             72                      BGS             cell_growth_inhibition  alamarBlue

#Will be working with: YRI (8 drugs), CEU (8 drugs), and ASN (4 drugs) 


#2 Create relationship matrix (GRM) in gemma: requires genotype file and phenotype file
#Individuals in these populations are related, parent child trios, must account for this when running association studies
#will use: gemma -g genotype.gz -p phenotype.txt -gk 1 -maf 0.05 -o output_name
    #working with YRI:
       Genotype file in BIMBAM format: YRI.TGP_and_imputed.rmBAD.20130526.geno.gz
       Phenotype file: must make from master_cyctotoxicity file
       
#Make phenotype file in R, use only YRI, use only one phenotype
    #no header, no IDs for .txt for gemma
    #With header/IDs (create for reference)
        pheno <- read.table("/home/ashley/LCL_chemotherapy/master_cytotoxicity_info_130311_plus_igrowth.txt", header = T)
        YRI <- subset(pheno, pop == "YRI")
        pheno_YRI_araclog2IC50 <- YRI[, 1:13]
    #Without header/IDs (create for use)
        pheno_YRI_araclog2IC50_noids <- pheno_YRI_araclog2IC50[, 5:13]

    #More individuals with phenotypes (180) than genotypes (178) - need the same amount and same individuals
    #Individuals also must be in the same order in both geno and pheno files
    
    #Next must order phenotype file to match order of genotype file
        fam <- read.table("/home/ashley/LCL_chemotherapy/YRI.chr10.TGP_and_imputed.20130416.exclude_BAD_SNPs.fam")
        colnames(fam) <- c("FID", "IID", "FatID", "MatID", "Sex", "Pheno")
        pheno_ordered <- left_join(fam, pheno_YRI_araclog2IC50, by = c("FID" = "FID", "IID" = "IID"))
        write.table(pheno_ordered, "/home/ashley/LCL_chemotherapy/ordered_pheno_YRI_araclog2IC50.txt", col.names = T, row.names = T, sep = "\t")
        #file with no ids or col names is one needed for gemma use
        pheno_ordered_noids <- pheno_ordered[, 10:17]
        write.table(pheno_ordered_noids, "/home/ashley/LCL_chemotherapy/ordered_pheno_YRI_araclog2IC50_noids.txt", col.names = F, row.names = F, sep = "\t")
    
#Run gemma
    gemma -g YRI.TGP_and_imputed.rmBAD.20130526.geno.gz -p ordered_pheno_YRI_araclog2IC50_noids.txt -gk 1 -maf 0.05 -o YRI_relationship_matrix_maf
    created files: YRI_relationship_matrix_maf.cXX.txt & YRI_relationship_matrix_maf.log.txt
    
    
#3 Make drug based phenotype files in R
    master_phenos <- read.table ("/home/ashley/LCL_chemotherapy/master_cyctotoxicity_info_130311_plus_igrowth.txt", header = T)
    YRI_master_phenos <- subset(master_phenos, pop == "YRI")
    YRI_master_phenos_ordered <- left_join(fam, YRI_master_pheno, by = c("FID" = "FID", "IID" = "IID", "FatID" = "father", "MatID" = "mother", "Sex" = "sex"))
    
    # for arac:
    YRI_arac_pheno <- select(YRI_master_phenos_ordered, 1:13, - Pheno, contains("ARAC"))
    
    # general:
    YRI_drug_pheno <- select(YRI_master_phenos_ordered, 1:13, - Pheno, contains("DRUGABBREV"))
     
    
#4 Run (univariate mixed linear) GWAS in gemma using GRM
    #For cisplatin: pheno IC50, use rank normalized (Rn)
    
    #In R: 
    #file with ids and phenotype (for reference)
    YRI_cisplatin_bestpheno <- select(YRI_cisplatin_pheno, 1:12, contains("CIS_RnIC50"))
    write.table(YRI_cisplatin_bestpheno, "/home/ashley/LCL_chemotherapy/YRI_cisplatin_bestpheno.txt", col.names = T, row.names = F, sep = "/t")
    #file phenotype only (for gemma)
    YRI_cisplatin_bestpheno_noids <- select(YRI_cisplatin_bestpheno, contains("CIS"))
    write.table(YRI_cisplatin_bestpheno_noids, "/home/ashley/LCL_chemotherapy/YRI_cisplatin_bestpheno_noids.txt", col.names = F, row.names = F, sep = "/t")
    
    #In Gemma:
    gemma -g YRI.TGP_and_imputed.rmBAD.20130526.geno.gz -p YRI_cisplatin_bestpheno_noids.txt -a YRI.TGP_and_imputed.rmBAD.20130526.snp.info.gz -k YRI_relationship_matrix_maf.cXX.txt -lmm 4 -o YRI_GWAS_cisplatin
    
    #error: segmentation fault
    
    #Unzip snp file with:
    gunzip filename.snp.info.gz
    run again
    gemma -g YRI.TGP_and_imputed.rmBAD.20130526.geno.gz -p YRI_cisplatin_bestpheno_noids.txt -a YRI.TGP_and_imputed.rmBAD.20130526.snp.info -k YRI_relationship_matrix_maf.cXX.txt -lmm 4 -o YRI_GWAS_cisplatin
    
    #Code is running...
    created files: YRI_GWAS_cisplatin.assoc.txt & YRI_GWAS_cisplatin.log.txt
    
    #p-value is nan/-nan.
    #try with carboplatin
    #wanted to try unzipping genotype file, as this worked with snp file
    gunzip filename.geno.gz
    #run with unzipped geno
    gemma -g YRI.TGP_and_imputed.rmBAD.20130526.geno -p YRI_carboplatin_bestpheno_noids.txt -a YRI.TGP_and_imputed.rmBAD.20130526.snp.info -k YRI_relationship_matrix_maf.cXX.txt -lmm 4 -o YRI_GWAS_carboplatin
    
    #code ran and sure enough I got p-values this time!!
    
    #code takes ~ an hour to run. To run in the background instead:
    use .sh file
    cp /home/wheelerlab3/testjob.sh /home/ashley/LCL_chemotherapy/
    #In LCL_chemothearpy:
    mkdir logs
    #open .sh file in R and edit, input what to run at bottom and adjust names
    #run in command line with:
    qsub backgroundjob.sh
    #check status with:
    qstat
    #end a task with:
    qdel task_num
 
    ##repeat the steps above with other drugs and populations


#5 Make plots in R
#Script: 01_GWAS_plots.R
#Creates plots for each drug in a population, run once per pop

  
#6 Predixcan
   
#6.1 Get files/info needed for Predixcan:
    #Dosagefile_path: Wants a directory as the input. Must make 22 dosage files (one for each chr) and put in that directory!
        Convert files from bimbam format to dosage format:
        Script: 99_BIMBAM_to_PX_dosages.py (found in Ad_PX_pipe, forked from aandaleon)
            #input: geno file and snp info file, both in BIMBAM format
                #input files:
                geno: YRI.TGP_and_imputed.rmBAD.20130526.geno
                snp: YRI.TGP_and_imputed.rmBAD.20130526.snp.info
            #Run: 
                python 99_BIMBAM_to_PX_dosages.py --anno YRI.TGP_and_imputed.rmBAD.20130526.snp.info --BIMBAM YRI.TGP_and_imputed.rmBAD.20130526.geno --output dosages.txt
            #output: combined file in dosage format, which is sebsquently split into 22 files
            #use awk command: awk '$1 == #' dosages.txt > chr#.txt, where # is 1 through 22, run 22 times
                #output files, chr1-22:
                predixcan_dosages/chr#.txt
                #must zip files for PrediXcan to run, use gzip     
    #Dosage_prefix: always chr!
    #Samples_file: Must make!
        #Make file with FID and IID only (in correct order corresponding to columns of individuals in geno file)
        #Use R, extract first two columns of fam file:
            samples <- fam[1:2]
            write.table(samples, file = "samples.txt", sep = "\t", row.names = F, col.names = F, quote = F)
            #output file:
            sample.txt
    #Weights: Prediction databases, run all in loop!
        #European predictors derived from various organ tissues samples
        #Located in: /home/wheelerlab3/Data/PrediXcan_db/GTEx-V7_HapMap-2017-11-29/
        #5 additional multi-ethnic predictors derived from white blood cell samples
        #Located in: /home/ryan/enet_scripts/new_MESA/dbs/  use: filtered_rsid_hg19.db   
    #Output_prefix: Change with each run!
        #Make a prefix for each db:
            #Example for YRI and db 1: YRI_results_Adipose_Subcutaneous
    
 #6.2 Run PrediXcan with GTEx V7 tissue dbs
    #Script: 03_PrediXcan1_loop.sh
        #Goes through each tissue db, run once per pop
        #Template for step one:
            PrediXcan.py --predict --dosages dosagefile_path --dosages_prefix chr --samples samples_file --weights prediction_db --output_prefix results/tissue
        #YRI Example with 1st db:
            PrediXcan.py --predict --dosages /home/ashley/LCL_chemotherapy/YRI/YRI_predixcan_dosages --dosages_prefix chr --samples /home/ashley/LCL_chemotherapy/YRI/samples.txt --weights /home/wheelerlab3/Data/PrediXcan_db/GTEx-V7_HapMap-2017-11-29/gtex_v7_Adipose_Subcutaneous_imputed_europeans_tw_0.5_signif.db --output_prefix YRI_results_Adipose_Subcutaneous    
    #Convert PrediXcan Step one output to "geno" input for GEMMA
        #Script: 03_pred_exp_to_GEMMA_input.R (found in px_his_chol, forked from WheelerLab)
            #Creates "geno" input files for gemma
    #Run gemma to account for relatedness:
        #Script: 05_PrediXcan2_loop.sh
        #Goes through each tissue db, drug, and pop; must run ASN separtely though as it has 4 of 8 drugs
        #YRI example with 1st db and carboplatin:
            gemma -g /home/ashley/LCL_chemotherapy/YRI/YRI_assoc_gemma_input/Adipose_Subcutaneous -notsnp -p /home/ashley/LCL_chemotherapy/YRI/YRI_phenotypes/YRI_carboplatin_bestpheno_noids.txt -k YRI_relationship_matrix_maf.cXX.txt -lmm 4 -o YRI_assoc_carboplatin_[tissue]
            #YRI has 8 drugs phenos
         
 #6.3 Run PrediXcan with MESA dbs:
    #Same process as above but pulls dbs from diff directory

#7 Going through results!
    #Condensing GWAS results:
        #Script: 06a_GWAS_output_condesner.R
            #Pulls out results with 10^-5 and 10^-7 significance from each drug file, outputs two files
            #run three times total, one per population, total of six output files
    #Condensing PrediXcan results:
        #Script 1: 06b_PrediXcan_output_condenser.R
            #Lots of assoc files, want to condense for significant results only
            #Pulls out results with 10^-3 significant and 10^-5 significance for each drug in each population, outputs two files
            #run twenty times total, one per drug per population, total of forty output files
        #Script 2: 06c_total_gene_count.R
            #Creates data frame of the number of genes measured in each tissue per population
    #Go through top hits:
        #look up top hits by ID on NCBI
    
#8 Make plots from PrediXcan condensed results
